# タスク管理 Macアプリ 要件定義

## 概要
Claude Codeと連携するローカルタスク管理のMacネイティブアプリ。
既存のSQLite DB (`~/workspace/task/tasks.db`) を直接読み書きし、リアルタイムでタスクを表示・編集する。

## 技術スタック
- SwiftUI + AppKit
- SQLite直接アクセス（GRDB or sqlite3 C API）
- Markdownレンダリング: [MarkdownUI](https://github.com/gonzalezreal/swift-markdown-ui)（SPMで導入）
- Xcodeプロジェクト

## アプリ仕様

### 起動・表示
- メニューバー常駐（Dockには表示しない）
- **Control キー2回押し**（0.5秒以内）でウィンドウをトグル表示/非表示
  - グローバルキーイベント監視（CGEvent tap / NSEvent.addGlobalMonitorForEvents）
  - 他のアプリがフォーカス中でも反応する
  - Control単押し2回のみ反応（Control+他キーの組み合わせでは発動しない）
- ウィンドウはフローティング（常に最前面にオプション切替可能）
- 起動時に自動でメニューバーに常駐
- アクセシビリティ権限が必要（初回起動時に許可を促すダイアログ表示）

### データソース
- ファイル: `~/workspace/task/tasks.db`
- テーブル: `tasks`
- スキーマ:
  ```sql
  CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT '未着手',  -- 未着手/進行中/今日やる/完了/アーカイブ
    priority TEXT,                           -- 高/中/低
    category TEXT,                           -- SPECRA/業務委託/個人
    due_date TEXT,                           -- YYYY-MM-DD
    completed_date TEXT,                     -- YYYY-MM-DD
    parent_task_id INTEGER,
    tags TEXT,                               -- カンマ区切り
    memo TEXT,
    created_at TEXT DEFAULT (datetime('now','localtime')),
    updated_at TEXT DEFAULT (datetime('now','localtime')),
    FOREIGN KEY (parent_task_id) REFERENCES tasks(id)
  );
  ```

### リアルタイム更新
- DBファイルの変更を監視（FSEvents / DispatchSource）
- Claude CodeがDBを更新したら自動でUIに反映
- ポーリング不要、ファイル変更イベントで再読み込み

### カンバンボードUI
- 4カラム: 未着手 / 進行中 / 今日やる / 完了
- カード表示内容: タスク名、期限、優先度バッジ、カテゴリバッジ、サブタスク数、メモアイコン
- 期限切れは赤色で表示
- ドラッグ&ドロップでステータス変更
- ダークテーマ（既存board.htmlと同じ配色）
- サブタスクがある場合、カード上に「▶ サブタスク (2/5)」のように進捗表示

### カラー定義
| 要素 | 色 |
|------|-----|
| 背景 | #191919 |
| カラム背景 | #252525 |
| カード背景 | #2d2d2d |
| 未着手ドット | #9b9b9b |
| 進行中ドット | #2e90fa |
| 今日やるドット | #f79009 |
| 完了ドット | #12b76a |
| 優先度・高 | #f04438 |
| 優先度・中 | #f79009 |
| 優先度・低 | #12b76a |
| カテゴリ・SPECRA | #5bb8ff |
| カテゴリ・業務委託 | #f7c948 |
| カテゴリ・個人 | #ee46bc |

### メモ機能

- タスクごとにメモを保存可能
- 編集モーダル内にメモ欄を表示（複数行テキストエリア）
- メモがあるタスクにはカード上にメモアイコン（📝）を表示
- **簡易Markdown対応**（以下の記法をレンダリング）:
  - 見出し: `# H1`、`## H2`、`### H3`
  - 箇条書きリスト: `- item` / `* item`
  - チェックリスト: `- [ ] TODO` / `- [x] 完了`
  - **太字**: `**text**`
  - テキスト改行
- 編集時はプレーンテキスト入力（TextEditor）、プレビューは MarkdownUI でレンダリング表示
- エディタ/プレビューをタブまたはトグルボタンで切替
- DBの `memo` カラムにMarkdownテキストとして保存

### サブタスク機能

- 既存の `parent_task_id` カラムを利用した親子関係
- **カンバンボード上の表示**:
  - サブタスクは親タスクのカード内に折りたたみ表示
  - 展開するとサブタスク一覧がカード内にインラインで表示される
  - サブタスクの完了数/全体数を親カードに表示（例: 「2/5 完了」）
  - サブタスクは独立したカードとしてはカンバンに表示しない（親カード内のみ）
- **サブタスク操作**:
  - 親タスクの編集モーダルからサブタスクを追加
  - サブタスク追加時はタスク名のみ入力（ステータスは「未着手」で作成）
  - サブタスクのチェックボックスで完了/未完了をトグル（モーダル内）
  - サブタスクをクリックで個別編集可能（名前、ステータス、メモ）
  - サブタスク削除はスワイプまたは削除ボタン
- **ネスト制限**: サブタスクは1階層のみ（サブタスクのサブタスクは作れない）
- **親タスク完了時**: 未完了のサブタスクがある場合は確認ダイアログ表示
  - 「すべて完了にする」or「キャンセル」を選択

### タスク編集
- カードクリックで編集モーダル表示
- 編集可能項目: タスク名、ステータス、期限、優先度、カテゴリ、タグ、メモ
- サブタスク一覧・追加エリア（上記「サブタスク機能」参照）
- 削除ボタン（確認ダイアログあり）
  - サブタスクがある親タスク削除時は「サブタスクも一緒に削除」の確認
- 保存時にDBに直接書き込み

### タスク追加
- 各カラム下部に「+ 新規タスク」ボタン
- インラインフォームでタスク名・期限・カテゴリ・優先度を入力

### ソート順
- 優先度順（高 > 中 > 低 > なし）
- 同優先度内は期限順（早い順）
- サブタスクは親タスク内で作成順（id順）

## 将来の拡張（今回は対象外）
- iPhone連携（iCloud経由でJSON読み取り専用）
- Cloudflare D1移行（マルチデバイス書き込み対応）
- メニューバーアイコンクリックでクイックビュー
- 通知（期限切れアラート）
- サブタスクの複数階層対応
- メモのMarkdown拡張（コードブロック、リンク、画像など）
